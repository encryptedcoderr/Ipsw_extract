name: IPSW → Extract iPhone 16 (18.6) exploit kit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:        # manual trigger button

jobs:
  extract:
    runs-on: macos-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          brew install ipsw
          # jtool2 is not in brew – grab signed binary
          curl -L -o /usr/local/bin/jtool2 https://github.com/JohnCoates/jtool2/releases/download/v2.1/jtool2-mac
          chmod +x /usr/local/bin/jtool2
          ipsw version
          jtool2 -h >/dev/null

      - name: Download iPhone 16 18.6 IPSW
        run: |
          # Apple CDN direct link (JSON plist gives the URL)
          IPSW_URL=$(ipsw download list --device iPhone17,3 --build 22G813 --url)
          echo "Downloading $IPSW_URL"
          curl -L -o iPhone17,3_18.6_22G813_Restore.ipsw "$IPSW_URL"

      - name: Create lab folder
        run: mkdir -p kit/{kernel,dyld,bundle,sandbox,log}

      - name: 1. Kernel kit
        run: |
          ipsw kernel symbolicate iPhone17,3_18.6_22G813_Restore.ipsw > kit/kernel/ksyms.txt
          ipsw kernel kexts      iPhone17,3_18.6_22G813_Restore.ipsw > kit/kernel/kexts.txt
          ipsw kernel syscall    iPhone17,3_18.6_22G813_Restore.ipsw > kit/kernel/syscalls.txt
          ipsw kernel dec        iPhone17,3_18.6_22G813_Restore.ipsw -o kit/kernel/kernel.decompressed

      - name: 2. AppleDNG + ImageIO
        run: |
          # mount & copy
          ipsw mount fs iPhone17,3_18.6_22G813_Restore.ipsw /tmp/fs
          cp /tmp/fs/System/Library/CoreServices/RawCamera.bundle/AppleDNG kit/bundle/
          # ImageIO from shared cache
          ipsw dyld extract -o kit/dyld iPhone17,3_18.6_22G813_Restore.ipsw ImageIO
          # gadgets
          jtool2 -S kit/dyld/ImageIO.dylib | grep -E '(serialize|getExternal)' > kit/dyld/ImageIO_gadgets.txt

      - name: 3. Sandbox & entitlements
        run: |
          cp /tmp/fs/usr/share/sandbox/*mediaanalysis* kit/sandbox/
          ipsw ent -b mediaanalysisd iPhone17,3_18.6_22G813_Restore.ipsw > kit/sandbox/mediaanalysisd.ent

      - name: 4. IOSurface headers (victim object)
        run: |
          ipsw dyld objc -H -o kit/dyld/IOSurfaceRootUC.h iPhone17,3_18.6_22G813_Restore.ipsw IOSurfaceRootUserClient

      - name: 5. Patch-diff reference (18.6.2)
        run: |
          # download patched bundle for diff
          IPSW_18_6_2=$(ipsw download list --device iPhone17,3 --build 22G818 --url)
          curl -L -o 18.6.2.ipsw "$IPSW_18_6_2"
          ipsw mount fs 18.6.2.ipsw /tmp/fs2
          bsdiff /tmp/fs/System/Library/CoreServices/RawCamera.bundle/AppleDNG \
                 /tmp/fs2/System/Library/CoreServices/RawCamera.bundle/AppleDNG \
                 kit/bundle/AppleDNG.18.6.1_to_18.6.2.patch
          xxd kit/bundle/AppleDNG.18.6.1_to_18.6.2.patch > kit/bundle/AppleDNG.patch.hex

      - name: 6. Zip artefacts
        run: |
          tar -czf iPhone16_18.6_exploit_kit.tgz kit/
          echo "KIT_SIZE=$(ls -lh iPhone16_18.6_exploit_kit.tgz | awk '{print $5}')" >> $GITHUB_ENV

      - name: 7. Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: iPhone16-18.6-exploit-kit
          path: iPhone16_18.6_exploit_kit.tgz
          retention-days: 7
