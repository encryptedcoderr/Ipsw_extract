name: IPSW Extraction Workflow

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: macos-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Tools
      run: |
        brew install ipsw
        brew tap excitedplus1s/repo
        brew install excitedplus1s/repo/jtool2 || true

    # ---------------------------------------------------------------
    # FIXED: The error occurs because build 22G813 is NOT in ipsw.me API.
    # Instead: query via AppleDB using: ipsw download appledb
    # ---------------------------------------------------------------

    - name: Query IPSW URL (AppleDB, not ipsw.me)
      id: geturl
      run: |
        echo "Querying AppleDB for iPhone17,3 build 22G813…"

        ipsw download appledb --device iPhone17,3 --build 22G813 --urls > urls.txt

        URL=$(grep -Eo 'https://[a-zA-Z0-9./?=_:-]+' urls.txt | head -n1)

        if [ -z "$URL" ]; then
          echo "❌ ERROR: AppleDB did not return a valid IPSW URL."
          exit 1
        fi

        echo "IPSW_URL=$URL" >> $GITHUB_ENV

    - name: Download IPSW
      run: |
        curl -L "$IPSW_URL" -o firmware.ipsw
        ls -lh firmware.ipsw

    - name: Extract kernel
      run: |
        mkdir -p out/kernel
        ipsw extract --kernel firmware.ipsw -o out/kernel

    - name: Extract dyld_shared_cache
      run: |
        mkdir -p out/dyld
        ipsw dyld extract firmware.ipsw -o out/dyld

    - name: Package output
      run: |
        tar -czf ipsw_out.tgz out/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ipsw-out
        path: ipsw_out.tgz
